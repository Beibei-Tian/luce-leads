<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Luce Sales Lead Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-slate-50 font-sans">

<div class="max-w-6xl mx-auto p-4 md:p-8">
    <div class="flex justify-between items-center mb-10">
        <div>
            <h1 class="text-3xl font-black text-slate-900 tracking-tighter">LUCE <span class="text-blue-600">SALES</span></h1>
            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Babysitting Vertical | Lead Viewer</p>
        </div>
        <button onclick="loadData()" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold shadow-lg flex items-center gap-2 transition hover:bg-blue-700">
            <i class="fas fa-sync-alt"></i> REFRESH
        </button>
    </div>

    <div id="leadGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <div class="col-span-full text-center py-20 text-slate-400 font-bold">Initializing Dashboard...</div>
    </div>
</div>

<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSTJWKWZ-qx8AnU7X8Shh8VElPJU_lvHvrtqhwEeJwKsu_BUmFUw5PO18nw38oTxOoL_EWif9KLNlPR/pub?output=csv";

async function loadData() {
    const grid = document.getElementById('leadGrid');
    grid.innerHTML = '<div class="col-span-full text-center py-20 text-slate-400 animate-pulse font-bold">Fetching latest leads...</div>';

    try {
        const proxyUrl = "https://api.allorigins.win/raw?url=" + encodeURIComponent(CSV_URL);
        const response = await fetch(proxyUrl);
        const csvText = await response.text();

        Papa.parse(csvText, {
            header: false,
            skipEmptyLines: true,
            complete: function(results) {
                renderDashboard(results.data);
            }
        });
    } catch (err) {
        grid.innerHTML = `<div class="col-span-full text-red-500 text-center py-20 font-bold">Failed to load data. Ensure the Google Sheet is published as CSV.</div>`;
    }
}

function renderDashboard(rows) {
    const grid = document.getElementById('leadGrid');
    grid.innerHTML = '';
    
    const dataRows = rows.slice(1).reverse();

    dataRows.forEach(row => {
        const lead = {
            timestamp: row[0],
            name:      row[1],
            ageY:      row[2],
            ageM:      row[3],
            postal:    row[4],
            start:     row[5],
            duration:  parseInt(row[6]) || 0,
            frequency: row[7] || row[8] || 'Ad-hoc',
            others:    row[22]
        };

        // --- GROUPING LOGIC ---
        let compulsory = [];
        let optional = [];

        // Columns 9-14: Must-Haves (Compulsory)
        for (let i = 9; i <= 14; i++) {
            if (row[i] && row[i].trim() !== "") {
                compulsory.push(row[i].replace(/Services Required \[|\]/g, ""));
            }
        }

        // Columns 15-21: Wish-to-Haves (Optional)
        for (let i = 15; i <= 21; i++) {
            if (row[i] && row[i].trim() !== "") {
                optional.push(row[i].replace(/Services Required \[|\]/g, ""));
            }
        }

        const isMiddayRisk = lead.duration >= 6 && 
            (lead.start.includes("11:3") || lead.start.includes("12:0") || lead.start.includes("12:3"));

        const card = document.createElement('div');
        card.className = `bg-white p-6 rounded-2xl shadow-sm border border-slate-200 flex flex-col justify-between transition hover:shadow-md ${isMiddayRisk ? 'ring-2 ring-red-500 bg-red-50' : ''}`;
        
        card.innerHTML = `
            <div>
                <div class="flex justify-between items-start mb-4">
                    <span class="text-[9px] font-black text-slate-400 uppercase">${lead.timestamp}</span>
                    ${isMiddayRisk ? '<span class="bg-red-600 text-white text-[9px] font-black px-2 py-0.5 rounded animate-bounce">UTILIZATION RISK</span>' : ''}
                </div>
                
                <h3 class="text-xl font-bold text-slate-800">${lead.name}</h3>
                <p class="text-blue-600 font-mono text-sm font-bold mb-4">${lead.postal}</p>
                
                <div class="grid grid-cols-2 gap-2 mb-4 bg-slate-50 p-3 rounded-xl border border-slate-100">
                    <div>
                        <p class="text-[9px] font-black text-slate-400 uppercase">Child Age</p>
                        <p class="text-xs font-bold text-slate-700">${lead.ageY}y ${lead.ageM}m</p>
                    </div>
                    <div>
                        <p class="text-[9px] font-black text-slate-400 uppercase">Duration</p>
                        <p class="text-xs font-bold text-slate-700">${lead.duration} Hours</p>
                    </div>
                </div>

                <div class="mb-4">
                    <p class="text-[9px] font-black text-slate-400 uppercase mb-1">Schedule & Frequency</p>
                    <p class="text-xs text-slate-600 font-medium">${lead.start}</p>
                    <p class="text-[10px] text-blue-500 font-bold uppercase">${lead.frequency}</p>
                </div>

                <!-- COMPULSORY SECTION -->
                <div class="mb-4">
                    <p class="text-[9px] font-black text-slate-800 uppercase mb-2 flex items-center gap-1">
                        <i class="fas fa-star text-amber-500"></i> Compulsory Services
                    </p>
                    <div class="flex flex-wrap gap-1">
                        ${compulsory.length > 0 
                            ? compulsory.map(s => `<span class="bg-slate-800 text-white text-[9px] px-2 py-0.5 rounded font-medium">${s}</span>`).join('') 
                            : '<span class="text-[9px] text-slate-400 italic">None selected</span>'}
                    </div>
                </div>

                <!-- OPTIONAL SECTION -->
                <div class="mb-6">
                    <p class="text-[9px] font-black text-slate-500 uppercase mb-2">
                        Optional Services (Wishes)
                    </p>
                    <div class="flex flex-wrap gap-1">
                        ${optional.length > 0 
                            ? optional.map(s => `<span class="bg-blue-100 text-blue-700 text-[9px] px-2 py-0.5 rounded font-medium">${s}</span>`).join('') 
                            : '<span class="text-[9px] text-slate-400 italic">None selected</span>'}
                    </div>
                    ${lead.others ? `<p class="mt-2 text-[10px] text-slate-500 bg-slate-50 p-2 rounded border border-dashed border-slate-200"><strong>Note:</strong> ${lead.others}</p>` : ''}
                </div>
            </div>

            <button onclick="copyToWhatsApp('${lead.name}', '${lead.postal}', '${lead.ageY}y ${lead.ageM}m', '${lead.start}', '${lead.duration}', '${compulsory.join(', ')}', '${optional.join(', ')}')" 
                    class="w-full bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-3 rounded-xl transition flex items-center justify-center gap-2 text-sm">
                <i class="fab fa-whatsapp"></i> COPY LEAD CARD
            </button>
        `;
        grid.appendChild(card);
    });
}

function copyToWhatsApp(name, postal, age, start, dur, compulsory, optional) {
    const text = `üö® *NEW LEAD*\nüë§ *Parent:* ${name}\nüìç *Postal:* ${postal}\nüë∂ *Child Age:* ${age}\n‚è∞ *Start:* ${start} (${dur} hrs)\n\n‚úÖ *COMPULSORY:* ${compulsory || 'None'}\n\nüåü *OPTIONAL:* ${optional || 'None'}`;
    navigator.clipboard.writeText(text);
    alert("Formatted Lead Card copied for WhatsApp!");
}

loadData();
</script>
</body>
</html>
